name: ğŸ¤– ì™„ì „ ìë™í™” KR TextStory Archive
on:
  push:
    paths:
      - "backup/**"
      - "scripts/**"
      - ".github/workflows/**"
  schedule:
    # ë§¤ 3ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰
    - cron: "0 */3 * * *"
  workflow_dispatch:
    description: "ìˆ˜ë™ íŠ¸ë¦¬ê±° - ì™„ì „ ìë™í™” ì‹¤í–‰"

jobs:
  auto-install:
    name: ğŸš€ ì™„ì „ ìë™í™” ì‹œìŠ¤í…œ
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install beautifulsoup4 lxml requests

      - name: ğŸ¤– ì™„ì „ ìë™í™” ì‹¤í–‰
        run: |
          echo "ğŸ¤– ì™„ì „ ìë™í™” ì‹œìŠ¤í…œ ì‹œì‘..."
          python scripts/auto_install.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š ê²°ê³¼ í†µê³„
        run: |
          echo "ğŸ“Š ìë™í™” ê²°ê³¼:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # ë°±ì—… íŒŒì¼ ê°œìˆ˜
          backup_count=$(find backup -name "*.html" 2>/dev/null | wc -l || echo "0")
          echo "ğŸ“ ë°±ì—… HTML íŒŒì¼: $backup_count"
          
          # ì•„ì¹´ì´ë¸Œ íŒŒì¼ ê°œìˆ˜ (index.html ì œì™¸)
          archive_count=$(find archive -name "*.html" ! -name "index.html" 2>/dev/null | wc -l || echo "0")
          echo "ğŸ›ï¸ ì•„ì¹´ì´ë¸Œ HTML íŒŒì¼: $archive_count"
          
          # manifest.json í™•ì¸
          if [ -f "assets/manifest.json" ]; then
            manifest_count=$(jq '.count' assets/manifest.json 2>/dev/null || echo "0")
            echo "ğŸ“„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í•­ëª©: $manifest_count"
            echo ""
            echo "ğŸ“– ìµœì‹  3ê°œ í•­ëª©:"
            jq -r '.items[:3][] | "  â€¢ \(.title) (\(.date))"' assets/manifest.json 2>/dev/null || echo "  (í•­ëª© ì—†ìŒ)"
          else
            echo "âŒ manifest.json íŒŒì¼ ì—†ìŒ"
          fi
          
          echo ""
          echo "ğŸŒ ì›¹ì‚¬ì´íŠ¸ URL:"
          echo "  â€¢ https://parksy.kr"
          echo "  â€¢ https://dtslib1979.github.io/UncleParksy/"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ” ë³€ê²½ì‚¬í•­ í™•ì¸
        id: changes
        run: |
          if git diff --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ë³€ê²½ì‚¬í•­ ê°ì§€ë¨"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status --porcelain
          fi

      - name: ğŸ“¤ ìë™ ì»¤ë°‹ & í‘¸ì‹œ
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.name "ğŸ¤– ìë™í™” ë´‡"
          git config --local user.email "automation@dtslib.com"
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ ì¶”ê°€
          git add archive/ assets/manifest.json
          
          # í†µê³„ ìˆ˜ì§‘
          archive_count=$(find archive -name "*.html" ! -name "index.html" 2>/dev/null | wc -l || echo "0")
          manifest_count=$(jq '.count' assets/manifest.json 2>/dev/null || echo "0")
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„±
          git commit -m "ğŸ¤– auto: KR TextStory Archive ìë™ ì—…ë°ì´íŠ¸
          
          ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:
          â€¢ ì•„ì¹´ì´ë¸Œ íŒŒì¼: ${archive_count}ê°œ
          â€¢ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í•­ëª©: ${manifest_count}ê°œ
          â€¢ ì²˜ë¦¬ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ğŸš€ ì™„ì „ ìë™í™” ì‹œìŠ¤í…œ by EduArt Engineer CI"
          
          git push

      - name: ğŸŒ ë°°í¬ í™•ì¸
        run: |
          echo "ğŸŒ GitHub Pages ë°°í¬ í™•ì¸ ì¤‘..."
          sleep 30  # ë°°í¬ ëŒ€ê¸°
          
          # curlë¡œ ì›¹ì‚¬ì´íŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          if curl -s -f "https://dtslib1979.github.io/UncleParksy/" > /dev/null; then
            echo "âœ… GitHub Pages ë°°í¬ ì„±ê³µ"
          else
            echo "âš ï¸ GitHub Pages ì ‘ê·¼ ì‹¤íŒ¨ (ë°°í¬ ì§„í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŒ)"
          fi
          
          # manifest.json ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          if curl -s -f "https://dtslib1979.github.io/UncleParksy/assets/manifest.json" > /dev/null; then
            echo "âœ… manifest.json ì ‘ê·¼ ì„±ê³µ"
          else
            echo "âš ï¸ manifest.json ì ‘ê·¼ ì‹¤íŒ¨"
          fi

      - name: âœ… ì™„ë£Œ ì•Œë¦¼
        run: |
          echo ""
          echo "ğŸ‰ ì™„ì „ ìë™í™” ì„±ê³µ!"
          echo ""
          echo "ğŸ”— í™•ì¸ ë§í¬:"
          echo "  â€¢ ë©”ì¸ ì‚¬ì´íŠ¸: https://parksy.kr"
          echo "  â€¢ GitHub Pages: https://dtslib1979.github.io/UncleParksy/"
          echo "  â€¢ ë§¤ë‹ˆí˜ìŠ¤íŠ¸: https://dtslib1979.github.io/UncleParksy/assets/manifest.json"
          echo ""
          echo "ğŸ¤– ë‹¤ìŒ ìë™ ì‹¤í–‰: 3ì‹œê°„ í›„"
          echo "ğŸ“ ìˆ˜ë™ ì‹¤í–‰: GitHub Actions â†’ 'Run workflow'"
