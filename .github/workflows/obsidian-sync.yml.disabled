name: ğŸ“¥ GitHub â†’ Obsidian ìë™ ë°±ì—… & ë™ê¸°í™”

on:
  # ë” ì•ˆì •ì ì¸ íŠ¸ë¦¬ê±°ë“¤
  push:
    branches: [main]
    paths:
      - 'category/**'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: "0 */3 * * *"  # 3ì‹œê°„ë§ˆë‹¤ (ë” ìì£¼, ë” ì•ˆì •ì )

permissions:
  contents: write

jobs:
  github-to-obsidian:
    # ì¡°ê±´ ì™„í™” (automation@dtslib.comë„ í—ˆìš©)
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        # ê¸°ë³¸ GITHUB_TOKEN ì‚¬ìš© (ê°„ë‹¨í•˜ê³  ì•ˆì •ì )
        
      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name "obsidian-backup-bot"
          git config --global user.email "obsidian@dtslib.com"
          
      - name: ğŸ› ï¸ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync pandoc
          
      - name: ğŸ“ Prepare Obsidian Folders
        run: |
          mkdir -p _obsidian/_imports/html_raw
          mkdir -p _obsidian/_imports/html_md
          echo "âœ… Obsidian í´ë” ì¤€ë¹„ ì™„ë£Œ"

      - name: ğŸ“Š Analyze Category Content
        id: analyze
        run: |
          if [ -d "category" ]; then
            HTML_COUNT=$(find category -name "*.html" -type f | wc -l)
            FOLDER_COUNT=$(find category -type d | wc -l)
            echo "html_count=$HTML_COUNT" >> $GITHUB_OUTPUT
            echo "folder_count=$FOLDER_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… ë¶„ì„ ì™„ë£Œ: HTML $HTML_COUNTê°œ, í´ë” $FOLDER_COUNTê°œ"
          else
            echo "âŒ category í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            exit 1
          fi

      - name: ğŸ“¥ RAW HTML Backup
        run: |
          echo "ğŸš€ RAW HTML ë°±ì—… ì‹œì‘..."
          
          # ì „ì²´ category í´ë”ë¥¼ html_rawì— ë™ê¸°í™”
          rsync -av --delete category/ _obsidian/_imports/html_raw/
          
          echo "âœ… RAW HTML ë°±ì—… ì™„ë£Œ"
          echo "ğŸ“Š ë°±ì—…ëœ íŒŒì¼ ìˆ˜: $(find _obsidian/_imports/html_raw -type f | wc -l)ê°œ"

      - name: ğŸ”„ HTML â†’ Markdown Conversion  
        run: |
          echo "ğŸ”„ HTML â†’ Markdown ë³€í™˜ ì‹œì‘..."
          
          # ëª¨ë“  HTML íŒŒì¼ì„ Markdownìœ¼ë¡œ ë³€í™˜
          find category -name "*.html" -type f | while read -r file; do
            # ìƒëŒ€ ê²½ë¡œ ê³„ì‚°
            rel_path="${file#category/}"
            md_dir="_obsidian/_imports/html_md/$(dirname "$rel_path")"
            mkdir -p "$md_dir"
            
            # .htmlì„ .mdë¡œ ë³€ê²½
            md_file="$md_dir/$(basename "$rel_path" .html).md"
            
            # pandocìœ¼ë¡œ ë³€í™˜ (ì‹¤íŒ¨í•˜ë©´ ê°„ë‹¨í•œ ë³€í™˜)
            if pandoc "$file" -f html -t gfm -o "$md_file" 2>/dev/null; then
              echo "âœ… ë³€í™˜ ì„±ê³µ: $rel_path"
            else
              echo "âš ï¸ pandoc ì‹¤íŒ¨, ê°„ë‹¨ ë³€í™˜: $rel_path"
              # HTML íƒœê·¸ ì œê±°í•˜ê³  ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ
              sed 's/<[^>]*>//g' "$file" | sed 's/&nbsp;/ /g' > "$md_file"
            fi
          done
          
          echo "âœ… HTML â†’ Markdown ë³€í™˜ ì™„ë£Œ"
          echo "ğŸ“Š ë³€í™˜ëœ íŒŒì¼ ìˆ˜: $(find _obsidian/_imports/html_md -name "*.md" -type f | wc -l)ê°œ"

      - name: ğŸ“‹ Generate Sync Report
        run: |
          cat > _obsidian/_imports/ë™ê¸°í™”_ë³´ê³ ì„œ.md << 'EOF'
# ğŸ“¥ GitHub â†’ Obsidian ë™ê¸°í™” ë³´ê³ ì„œ

## ğŸ• ë™ê¸°í™” ì •ë³´
- **ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')
- **íŠ¸ë¦¬ê±° ë°©ì‹**: ${{ github.event_name }}
- **ì»¤ë°‹ SHA**: ${{ github.sha }}
- **ì•¡í„°**: ${{ github.actor }}

## ğŸ“Š ì²˜ë¦¬ í†µê³„
- **HTML ì›ë³¸**: $(find _obsidian/_imports/html_raw -name "*.html" -type f | wc -l)ê°œ íŒŒì¼
- **Markdown ë³€í™˜**: $(find _obsidian/_imports/html_md -name "*.md" -type f | wc -l)ê°œ íŒŒì¼
- **ì „ì²´ í´ë”**: $(find _obsidian/_imports -type d | wc -l)ê°œ

## ğŸ“ ì¹´í…Œê³ ë¦¬ë³„ í˜„í™©
EOF

          # ì¹´í…Œê³ ë¦¬ë³„ íŒŒì¼ ìˆ˜ ì¶”ê°€
          for dir in _obsidian/_imports/html_md/*/; do
            if [ -d "$dir" ]; then
              category_name=$(basename "$dir")
              file_count=$(find "$dir" -name "*.md" -type f | wc -l)
              echo "- **$category_name**: $file_countê°œ íŒŒì¼" >> _obsidian/_imports/ë™ê¸°í™”_ë³´ê³ ì„œ.md
            fi
          done
          
          cat >> _obsidian/_imports/ë™ê¸°í™”_ë³´ê³ ì„œ.md << 'EOF'

## ğŸ¯ ì‚¬ìš© ë°©ë²•
1. **RAW HTML**: `_obsidian/_imports/html_raw/` - ì›ë³¸ HTML íŒŒì¼ë“¤
2. **Markdown**: `_obsidian/_imports/html_md/` - ë³€í™˜ëœ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë“¤  
3. **ìƒì—…í™” í™œìš©**: ì´ ìë£Œë“¤ì„ Obsidianì—ì„œ í¸ì§‘í•˜ì—¬ ìœ ë£Œ ì½˜í…ì¸ ë¡œ ê°œë°œ

## ğŸ’¡ ë°•ì”¨ë‹˜ ì „ëµ
- **Public GitHub**: í¬íŠ¸í´ë¦¬ì˜¤ & ë ˆí¼ëŸ°ìŠ¤ (ì‹¤ë ¥ ì¦ëª…)
- **Private Obsidian**: ë…¸í•˜ìš° & ìƒì—…ì  ìë£Œ (ìˆ˜ìµí™” ì†ŒìŠ¤)

---
*ìë™ ìƒì„± by EduArt Engineer CI*
EOF

      - name: ğŸ’¾ Commit & Push Changes
        run: |
          git add _obsidian/_imports/
          
          if ! git diff --cached --quiet; then
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            HTML_COUNT=$(find _obsidian/_imports/html_raw -name "*.html" -type f | wc -l)
            MD_COUNT=$(find _obsidian/_imports/html_md -name "*.md" -type f | wc -l)
            
            # ìƒì„¸í•œ ì»¤ë°‹ ë©”ì‹œì§€
            git commit -m "ğŸ“¥ Obsidian ìë™ë°±ì—…: HTML($HTML_COUNT) â†’ MD($MD_COUNT) [$TIMESTAMP]

ğŸ¯ GitHub â†’ Obsidian ë™ê¸°í™” ì™„ë£Œ
ğŸ“Š HTML: $HTML_COUNTê°œ â†’ Markdown: $MD_COUNTê°œ  
ğŸ”„ íŠ¸ë¦¬ê±°: ${{ github.event_name }}
â° ì‹œê°„: $TIMESTAMP UTC

ğŸ’° ìƒì—…í™” ì „ëµ: Public(í¬íŠ¸í´ë¦¬ì˜¤) â†’ Private(ë…¸í•˜ìš°)"
            
            git push
            
            echo "ğŸ‰ Obsidian ë°±ì—… ì„±ê³µ!"
            echo "ğŸ“Š í†µê³„: HTML $HTML_COUNTê°œ â†’ Markdown $MD_COUNTê°œ"
            echo "ğŸ“ ìœ„ì¹˜: _obsidian/_imports/"
            echo "ğŸ’¡ ì´ì œ Obsidianì—ì„œ ì´ ìë£Œë“¤ì„ ìƒì—…í™”ìš©ìœ¼ë¡œ í™œìš©í•˜ì„¸ìš”!"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
          fi